from PyQt5.QtWidgets import QMainWindow, QApplication,QTableWidgetItem
import sys
import psycopg2
from PyQt5.QtGui import QIntValidator,QDoubleValidator


from TelaInicial_ui import *
from TelaBuscarLivros_ui import *
from TelaAddLivro_ui import *


conexao = psycopg2.connect(host='localhost',
                                                database='Biblioteca',
                                                user='postgres',
                                                password='postgres')


class AddLivros(QMainWindow,Ui_TelaAddLivros) :
    def __init__(self,parent = None):   
        super().__init__(parent)
        super().setupUi(self)
        ano_de_lacamento = self.edtAno
        ano_de_lacamento.setValidator(QIntValidator())
        ano_de_lacamento.setMaxLength(4)
        preco = self.edtpreco
        preco.setValidator(QDoubleValidator())
        preco.setMaxLength(4)
        Livro = self.edtLivro.text()
        autor= self.edtAutor.text()
        self.btnaddlivro.clicked.connect(self.addLivros)
        
    def addLivros(self):
        print()

      
        

class BuscarLivros(QMainWindow,Ui_pesquisalivros) :
    def __init__(self,parent = None):
        super().__init__(parent)
        super().setupUi(self)
        self.BtnBuscarLivros.clicked.connect(self.buscarLivros)
        
    def buscarLivros(self):
        autor = self.edtautor.text()
        codigoLivro = self.sbCodigo.text()
        livro = self.edtlivro.text()
        if not autor and not livro:
            if  codigoLivro == '0'  :
                cursor = conexao.cursor()
                cursor.execute(f"SELECT id_livros,livro,autor,preco \
                                        FROM Livros \
                                        WHERE inativo =False\
                                        ORDER BY id_livros ASC")
                dadoslistados = cursor.fetchall()
                
                self.tblBuscalivros.clearContents()
                self.tblBuscalivros.setRowCount(len(dadoslistados))
                
                for linha, texto in enumerate(dadoslistados):
                    for coluna, data in enumerate(texto):
                        self.tblBuscalivros.setItem(linha,coluna,QTableWidgetItem(str(data)))
                        cursor.close()
            else:
                cursor = conexao.cursor()
                cursor.execute(f"SELECT id_livros,livro,autor,preco \
                                        FROM Livros \
                                        WHERE id_livros='{codigoLivro}' and  inativo =False\
                                        ORDER BY id_livros ASC")
                dadoslistados = cursor.fetchall()
                
                self.tblBuscalivros.clearContents()
                self.tblBuscalivros.setRowCount(len(dadoslistados))
                
                for linha, texto in enumerate(dadoslistados):
                    for coluna, data in enumerate(texto):
                        self.tblBuscalivros.setItem(linha,coluna,QTableWidgetItem(str(data)))
                        cursor.close()
        else:
            cursor = conexao.cursor()
            cursor.execute(f"SELECT id_livros,livro,autor,preco \
                                    FROM Livros \
                                    WHERE livro ILIKE '%{livro}%' AND autor ILIKE '%{autor}%' AND  inativo =False\
                                    ORDER BY id_livros ASC")
            dadoslistados = cursor.fetchall()
            
            self.tblBuscalivros.clearContents()
            self.tblBuscalivros.setRowCount(len(dadoslistados))
            
            for linha, texto in enumerate(dadoslistados):
                for coluna, data in enumerate(texto):
                    self.tblBuscalivros.setItem(linha,coluna,QTableWidgetItem(str(data)))
                    cursor.close()
            
            
            
            
class TelaInicial(QMainWindow,Ui_TelaPrinciapal) :
    def __init__(self,parent = None):
        super().__init__(parent)
        self.ui = Ui_TelaPrinciapal()
        self.ui.setupUi(self)
        self.ui.btnpesquisar.clicked.connect(self.entrar_telaBusacarLivros)
        self.ui.btnADDLivros.clicked.connect(self.entrar_addLivros)
        self.ui.btnSair.clicked.connect(self.sair_do_sistema)
        
    def sair_do_sistema(self):
        sys.exit(qt.exec_())
        
    def entrar_telaBusacarLivros(self):
        self.tela=BuscarLivros()
        self.tela.show()
        
    def entrar_addLivros(self):
        self.tela=AddLivros()
        self.tela.show()

if __name__ == '__main__':
    qt = QApplication(sys.argv)
    telainicial = TelaInicial()
    telainicial.show()
    qt.exec_()
    
